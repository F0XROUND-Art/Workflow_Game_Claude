<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰ã‚²ãƒ¼ãƒ </title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
            text-align: center;
        }
        .header h1 { font-size: 1.5em; margin-bottom: 10px; }
        .reset-data {
            margin-top: 10px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
        }
        .reset-data:hover { color: white; text-decoration: underline; }
        .level-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            font-size: 14px;
        }
        .level-selector {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .level-btn {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            position: relative;
            font-size: 16px;
        }
        .level-btn:hover, .level-btn:active { background: rgba(255,255,255,0.4); }
        .level-btn.active { background: rgba(255,255,255,0.9); color: #667eea; }
        .level-btn.cleared::after {
            content: 'âœ“';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #48bb78;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
        }
        .game-area { padding: 15px; }
        .instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .instructions h3 { color: #667eea; margin-bottom: 10px; font-size: 1.1em; }
        .scenario {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        .device-instruction {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-size: 13px;
        }
        .workspace {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        @media (min-width: 768px) {
            .workspace {
                grid-template-columns: 280px 1fr;
                gap: 30px;
            }
            .header h1 { font-size: 2em; }
            .game-area { padding: 40px; }
        }
        .node-palette {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .node-palette h3 { margin-bottom: 15px; color: #667eea; }
        .palette-node {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid #e0e0e0;
            transition: all 0.3s;
            position: relative;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .palette-node:active { transform: scale(0.95); }
        .palette-node.selected {
            border-color: #ffc107;
            background: #fff3cd;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
        }
        .palette-node:hover { border-color: #667eea; }
        .node-header { display: flex; align-items: center; gap: 10px; }
        .node-icon { font-size: 24px; }
        .node-desc {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .canvas {
            background: #fafafa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            min-height: 400px;
            padding: 10px;
            position: relative;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        .canvas-placeholder {
            text-align: center;
            color: #999;
            margin-top: 150px;
            pointer-events: none;
            font-size: 14px;
        }
        .placed-node {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 3px solid #667eea;
            position: absolute;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .placed-node .node-icon { font-size: 28px; margin-bottom: 5px; }
        .placed-node .node-name { font-weight: 600; font-size: 12px; }
        .placed-node:active { transform: scale(0.95); }
        .placed-node.connected { border-color: #48bb78; }
        .placed-node.selected {
            border-color: #ffc107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
        }
        .placed-node.error { border-color: #f56565; animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .connection-line {
            position: absolute;
            height: 4px;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transform-origin: left center;
            pointer-events: all;
            z-index: 1;
            cursor: pointer;
        }
        .connection-line:active { height: 6px; background: #f56565; }
        .connection-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            animation: flow 1.5s infinite;
        }
        @keyframes flow { 0% { left: -100%; } 100% { left: 200%; } }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .hint-box, .answer-box {
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
        }
        .hint-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        .answer-box {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        .hint-box.show, .answer-box.show { display: block; }
        .answer-box pre {
            background: white;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .success-modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .modal-content h2 { color: #48bb78; font-size: 1.8em; margin-bottom: 15px; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        .connection-status {
            margin-top: 10px;
            padding: 8px;
            background: #e3f2fd;
            border-radius: 5px;
            font-size: 13px;
        }
        .parallel-badge {
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        .mode-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }
        .mode-indicator.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰ã‚²ãƒ¼ãƒ </h1>
            <p>n8nã®ã‚ˆã†ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å­¦ã¼ã†ï¼</p>
            <div class="reset-data" onclick="resetAllData()">ğŸ”„ é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ</div>
            <div class="level-info">
                <div><strong>ãƒ¬ãƒ™ãƒ«:</strong> <span id="current-level">1</span> / 10</div>
                <div><strong>ã‚¯ãƒªã‚¢:</strong> <span id="cleared-count">0</span> / 10</div>
            </div>
            <div class="level-selector" id="level-selector"></div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div>
        </div>
        <div class="game-area">
            <div class="instructions">
                <h3>ğŸ“‹ ãƒŸãƒƒã‚·ãƒ§ãƒ³ <span id="parallel-indicator"></span></h3>
                <p id="mission-text"></p>
                <div class="scenario" id="scenario"></div>
                <div class="device-instruction" id="device-instruction"></div>
                <div class="connection-status" id="connection-status">æ¥ç¶šæ•°: <strong>0</strong></div>
            </div>
            <div class="workspace">
                <div class="node-palette">
                    <h3>ğŸ”§ ãƒãƒ¼ãƒ‰</h3>
                    <div id="palette"></div>
                </div>
                <div class="canvas" id="canvas">
                    <div class="canvas-placeholder">ã“ã“ã«ãƒãƒ¼ãƒ‰ã‚’é…ç½®</div>
                </div>
            </div>
            <div class="hint-box" id="hint-box"><strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong><p id="hint-text"></p></div>
            <div class="answer-box" id="answer-box"><strong>ğŸ” æ­£è§£:</strong><pre id="answer-text"></pre></div>
            <div class="controls">
                <button class="btn btn-primary" onclick="checkWorkflow()">âœ… å®Ÿè¡Œ</button>
                <button class="btn btn-secondary" onclick="resetCanvas()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="btn btn-secondary" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
                <button class="btn btn-secondary" onclick="showAnswer()">ğŸ” ç­”ãˆ</button>
            </div>
        </div>
    </div>
    <div class="success-modal" id="success-modal">
        <div class="modal-content">
            <h2>ğŸ‰ ã‚¯ãƒªã‚¢ï¼</h2>
            <p>ç´ æ™´ã‚‰ã—ã„ï¼æ­£ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚</p>
            <button class="btn btn-primary" onclick="nextLevel()" style="margin-top: 20px;">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ â†’</button>
        </div>
    </div>
    <div class="mode-indicator" id="mode-indicator"></div>
    <script>
const L=[{id:1,mission:"å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚ŒãŸã‚‰ã€è‡ªå‹•ã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚ŠãŸã„",scenario:"ğŸ’¼ Webã‚µã‚¤ãƒˆã®å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€šçŸ¥ãŒæ¥ãŸã‚‰ã€æ‹…å½“è€…ã«ãƒ¡ãƒ¼ãƒ«ã§çŸ¥ã‚‰ã›ã‚‹",nodes:["webhook","email"],correctConnections:[["webhook","email"]],hint:"Webhookã§ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ãƒãƒ¼ãƒ‰ã«ç¹‹ã’ã¾ã™",isParallel:false},{id:2,mission:"æ–°ã—ã„æ³¨æ–‡ãŒå…¥ã£ãŸã‚‰ã€Slackã§ãƒãƒ¼ãƒ ã«é€šçŸ¥ã—ãŸã„",scenario:"ğŸ›’ ECã‚µã‚¤ãƒˆã§æ³¨æ–‡ãŒå…¥ã£ãŸã‚‰ã€å³åº§ã«Slackã®å–¶æ¥­ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥",nodes:["webhook","slack"],correctConnections:[["webhook","slack"]],hint:"Webhookã§æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€Slackã«æµã—ã¾ã™",isParallel:false},{id:3,mission:"é‡è¦ãªé€šçŸ¥ã‚’ã€ãƒ¡ãƒ¼ãƒ«ã¨Slackä¸¡æ–¹ã«åŒæ™‚é€ä¿¡ã—ãŸã„",scenario:"âš¡ ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¤‡æ•°ã®ãƒãƒ£ãƒãƒ«ã«åŒæ™‚é…ä¿¡",nodes:["webhook","set","email","slack"],correctConnections:[["webhook","set"],["set","email"],["set","slack"]],hint:"Setã§æ•´å½¢å¾Œã€Emailã¨Slackä¸¡æ–¹ã«ä¸¦åˆ—é€ä¿¡",isParallel:true},{id:4,mission:"å•ã„åˆã‚ã›å†…å®¹ã‚’åˆ¤å®šã—ã¦ã€ç·Šæ€¥æ¡ˆä»¶ã ã‘ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã—ãŸã„",scenario:"ğŸ” ã€Œç·Šæ€¥ã€ãŒå«ã¾ã‚Œã‚‹å ´åˆã®ã¿ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ãã‚Œä»¥å¤–ã¯ä½•ã‚‚ã—ãªã„",nodes:["webhook","if","iftrue","iffalse","email"],correctConnections:[["webhook","if"],["if","iftrue"],["if","iffalse"],["iftrue","email"]],hint:"Webhookâ†’IFâ†’IF(True)ã¨IF(False)ã«åˆ†å²â†’IF(True)ã‹ã‚‰Emailã¸ã€‚IF(False)ã¯ãã“ã§çµ‚äº†",isParallel:true},{id:5,mission:"ãƒ–ãƒ­ã‚°ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã€è‡ªå‹•ã§Xã«æŠ•ç¨¿ã—ãŸã„",scenario:"ğŸ“° RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ç›£è¦–ã—ã¦ã€æ–°è¨˜äº‹ãŒã‚ã‚Œã°è‡ªå‹•ã‚·ã‚§ã‚¢",nodes:["rss","set","twitter"],correctConnections:[["rss","set"],["set","twitter"]],hint:"RSSâ†’Setâ†’XæŠ•ç¨¿",isParallel:false},{id:6,mission:"æ¯æœ9æ™‚ã«ã€ä»Šæ—¥ã®äºˆå®šã‚’Xã«è‡ªå‹•æŠ•ç¨¿ã—ãŸã„",scenario:"â° å®šæœŸçš„ã«æƒ…å ±ç™ºä¿¡",nodes:["schedule","set","twitter"],correctConnections:[["schedule","set"],["set","twitter"]],hint:"Scheduleâ†’Setâ†’XæŠ•ç¨¿",isParallel:false},{id:7,mission:"RSSã¨APIã®ä¸¡æ–¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã¦Slackã«é€ã‚ŠãŸã„",scenario:"ğŸ“Š è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±åé›†",nodes:["rss","http","merge","set","slack"],correctConnections:[["rss","merge"],["http","merge"],["merge","set"],["set","slack"]],hint:"RSSã¨HTTPâ†’Mergeâ†’Setâ†’Slack",isParallel:true},{id:8,mission:"Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’ã€è‡ªå‹•ã§noteã®è¨˜äº‹ã«ã—ãŸã„",scenario:"ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å…¬é–‹",nodes:["googledocs","set","note"],correctConnections:[["googledocs","set"],["set","note"]],hint:"GoogleDocsâ†’Setâ†’note",isParallel:false},{id:9,mission:"AIã§ãƒ–ãƒ­ã‚°è¨˜äº‹ã¨ç”»åƒã‚’ç”Ÿæˆã—ã¦ã€noteã«æŠ•ç¨¿ã—ãŸã„",scenario:"ğŸ¤– æ‰‹å‹•ã§ãƒ†ãƒ¼ãƒå…¥åŠ›ã—ãŸã‚‰ã€AIãŒæ–‡ç« ã¨ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆ",nodes:["manual","openai-text","openai-image","set","note"],correctConnections:[["manual","openai-text"],["openai-text","openai-image"],["openai-image","set"],["set","note"]],hint:"Manualâ†’AIãƒ†ã‚­ã‚¹ãƒˆâ†’AIç”»åƒâ†’Setâ†’note",isParallel:false},{id:10,mission:"RSSãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ»APIã‹ã‚‰æƒ…å ±ã‚’é›†ã‚ã¦Xã¨Slackã«é…ä¿¡ã—ãŸã„",scenario:"ğŸš€ å®Œå…¨è‡ªå‹•åŒ–ï¼šè¤‡æ•°ã‚½ãƒ¼ã‚¹â†’è¤‡æ•°ãƒãƒ£ãƒãƒ«",nodes:["rss","googlesheets","http","merge","set","twitter","slack"],correctConnections:[["rss","merge"],["googlesheets","merge"],["http","merge"],["merge","set"],["set","twitter"],["set","slack"]],hint:"3ã‚½ãƒ¼ã‚¹â†’Mergeâ†’Setâ†’X&Slack",isParallel:true}];
const N={webhook:{name:"Webhook",icon:"ğŸ”—",description:"å¤–éƒ¨ã‹ã‚‰ã®ãã£ã‹ã‘ã‚’å—ã‘å–ã‚‹"},email:{name:"Email",icon:"ğŸ“§",description:"ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡"},slack:{name:"Slack",icon:"ğŸ’¬",description:"Slackã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡"},set:{name:"Set",icon:"âš™ï¸",description:"ãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ãƒ»æ•´å½¢"},if:{name:"IF",icon:"ğŸ”€",description:"æ¡ä»¶åˆ†å²"},iftrue:{name:"IF (True)",icon:"âœ…",description:"æ¡ä»¶ãŒTrueã®å ´åˆ"},iffalse:{name:"IF (False)",icon:"âŒ",description:"æ¡ä»¶ãŒFalseã®å ´åˆ"},rss:{name:"RSS",icon:"ğŸ“°",description:"RSSãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—"},twitter:{name:"X",icon:"ğ•",description:"XæŠ•ç¨¿"},schedule:{name:"Schedule",icon:"â°",description:"æ™‚åˆ»æŒ‡å®šå®Ÿè¡Œ"},googledocs:{name:"Google Docs",icon:"ğŸ“„",description:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—"},note:{name:"note",icon:"ğŸ“",description:"noteæŠ•ç¨¿"},"openai-text":{name:"OpenAI Text",icon:"ğŸ¤–",description:"AIæ–‡ç« ç”Ÿæˆ"},"openai-image":{name:"OpenAI Image",icon:"ğŸ¨",description:"AIç”»åƒç”Ÿæˆ"},http:{name:"HTTP",icon:"ğŸŒ",description:"APIå–å¾—"},merge:{name:"Merge",icon:"ğŸ”—",description:"ãƒ‡ãƒ¼ã‚¿çµ±åˆ"},googlesheets:{name:"Sheets",icon:"ğŸ“Š",description:"ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ"},manual:{name:"Manual",icon:"ğŸ‘†",description:"æ‰‹å‹•å®Ÿè¡Œ"}};
let lv=1,pn=[],cn=[],cl=JSON.parse(localStorage.getItem('cl')||'[]'),fs=null,nid=0,dn=null,dof={x:0,y:0},isMobile='ontouchstart'in window,selectedPaletteNode=null;
const cv=document.getElementById('canvas'),mi=document.getElementById('mode-indicator');
function init(){const l=L[lv-1];document.getElementById('current-level').textContent=lv;document.getElementById('cleared-count').textContent=cl.length;document.getElementById('mission-text').textContent=l.mission;document.getElementById('scenario').textContent=l.scenario;document.getElementById('progress-fill').style.width=(cl.length/L.length*100)+'%';document.getElementById('parallel-indicator').innerHTML=l.isParallel?'<span class="parallel-badge">ä¸¦åˆ—</span>':'';const inst=isMobile?'ğŸ“± ãƒãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—â†’ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã§é…ç½®ã€‚é…ç½®å¾Œã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•':'ğŸ’» ãƒãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°â†’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ‰ãƒ­ãƒƒãƒ—ã€‚é…ç½®å¾Œã‚‚ç§»å‹•å¯èƒ½';document.getElementById('device-instruction').textContent=inst;const p=document.getElementById('palette');p.innerHTML='';l.nodes.forEach(t=>{const n=N[t];const d=document.createElement('div');d.className='palette-node';d.dataset.type=t;if(!isMobile){d.draggable=true;d.addEventListener('dragstart',e=>e.dataTransfer.setData('t',t));}else{d.addEventListener('click',()=>selectPaletteNode(d));}d.innerHTML=`<div class="node-header"><span class="node-icon">${n.icon}</span><span>${n.name}</span></div><div class="node-desc">${n.description}</div>`;p.appendChild(d);});updateLevelSelector();reset();}
function selectPaletteNode(node){if(selectedPaletteNode)selectedPaletteNode.classList.remove('selected');selectedPaletteNode=node;node.classList.add('selected');mi.textContent='ğŸ“ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é…ç½®';mi.classList.add('show');setTimeout(()=>mi.classList.remove('show'),3000);}
function updateLevelSelector(){const s=document.getElementById('level-selector');s.innerHTML='';for(let i=1;i<=L.length;i++){const b=document.createElement('button');b.className='level-btn'+(i===lv?' active':'')+(cl.includes(i)?' cleared':'');b.textContent=i;b.onclick=()=>{lv=i;init();};s.appendChild(b);}}
if(!isMobile){cv.addEventListener('dragover',e=>e.preventDefault());cv.addEventListener('drop',e=>{e.preventDefault();const t=e.dataTransfer.getData('t');placeNode(t,e.clientX,e.clientY);});}else{cv.addEventListener('click',e=>{if(selectedPaletteNode&&e.target===cv||e.target.classList.contains('canvas-placeholder')){const t=selectedPaletteNode.dataset.type;const rect=cv.getBoundingClientRect();placeNode(t,e.clientX,e.clientY);selectedPaletteNode.classList.remove('selected');selectedPaletteNode=null;}});}
function placeNode(t,clientX,clientY){const n=N[t];const pl=cv.querySelector('.canvas-placeholder');if(pl)pl.remove();const d=document.createElement('div');d.className='placed-node';d.dataset.type=t;d.dataset.id='n'+(nid++);d.innerHTML=`<div class="node-icon">${n.icon}</div><div class="node-name">${n.name}</div>`;const rect=cv.getBoundingClientRect();d.style.left=(clientX-rect.left-50)+'px';d.style.top=(clientY-rect.top-50)+'px';if(isMobile){let isDragging=false,startX,startY,startLeft,startTop;d.addEventListener('touchstart',e=>{const touch=e.touches[0];startX=touch.clientX;startY=touch.clientY;startLeft=parseInt(d.style.left);startTop=parseInt(d.style.top);isDragging=false;});d.addEventListener('touchmove',e=>{e.preventDefault();isDragging=true;const touch=e.touches[0];const dx=touch.clientX-startX;const dy=touch.clientY-startY;d.style.left=(startLeft+dx)+'px';d.style.top=(startTop+dy)+'px';rd();});d.addEventListener('touchend',()=>{if(!isDragging)cc(d);});}else{d.addEventListener('mousedown',sd);d.addEventListener('click',()=>!dn&&cc(d));}cv.appendChild(d);pn.push(d);}
function sd(e){if(e.button!==0)return;dn=e.currentTarget;const r=dn.getBoundingClientRect();const cr=cv.getBoundingClientRect();dof.x=e.clientX-r.left;dof.y=e.clientY-r.top;document.addEventListener('mousemove',dd);document.addEventListener('mouseup',su);e.preventDefault();}
function dd(e){if(!dn)return;const cr=cv.getBoundingClientRect();dn.style.left=(e.clientX-cr.left-dof.x)+'px';dn.style.top=(e.clientY-cr.top-dof.y)+'px';rd();}
function su(){document.removeEventListener('mousemove',dd);document.removeEventListener('mouseup',su);dn=null;}
function cc(n){if(!fs){fs=n;n.classList.add('selected');}else if(fs===n){fs.classList.remove('selected');fs=null;}else{cn.push({from:fs.dataset.type,to:n.dataset.type,fe:fs,te:n});fs.classList.remove('selected');fs.classList.add('connected');n.classList.add('connected');dl(fs,n);fs=null;us();}}
function dl(f,t){const l=cl2(f,t);if(isMobile){l.addEventListener('touchstart',function(e){e.stopPropagation();if(confirm('ã“ã®æ¥ç¶šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))rc(this);});}else{l.onclick=function(){rc(this);};}cv.appendChild(l);}
function cl2(f,t){const fr=f.getBoundingClientRect();const tr=t.getBoundingClientRect();const cr=cv.getBoundingClientRect();const fx=fr.left+fr.width/2-cr.left;const fy=fr.top+fr.height/2-cr.top;const tx=tr.left+tr.width/2-cr.left;const ty=tr.top+tr.height/2-cr.top;const len=Math.sqrt(Math.pow(tx-fx,2)+Math.pow(ty-fy,2));const ang=Math.atan2(ty-fy,tx-fx)*180/Math.PI;const l=document.createElement('div');l.className='connection-line';l.style.width=len+'px';l.style.left=fx+'px';l.style.top=fy+'px';l.style.transform=`rotate(${ang}deg)`;l.dataset.from=f.dataset.id;l.dataset.to=t.dataset.id;return l;}
function rd(){document.querySelectorAll('.connection-line').forEach(l=>{const f=document.querySelector(`[data-id="${l.dataset.from}"]`);const t=document.querySelector(`[data-id="${l.dataset.to}"]`);if(f&&t){const nl=cl2(f,t);l.style.width=nl.style.width;l.style.left=nl.style.left;l.style.top=nl.style.top;l.style.transform=nl.style.transform;}});}
function rc(l){const fi=l.dataset.from;const ti=l.dataset.to;cn=cn.filter(c=>!(c.fe.dataset.id===fi&&c.te.dataset.id===ti));l.remove();us();}
function us(){document.getElementById('connection-status').innerHTML=`æ¥ç¶šæ•°: <strong>${cn.length}</strong>`;}
function checkWorkflow(){const l=L[lv-1];const pt=pn.map(n=>n.dataset.type);const mn=l.nodes.filter(n=>!pt.includes(n));if(mn.length>0){er(`æœªé…ç½®: ${mn.map(t=>N[t].name).join(', ')}`);return;}const uc=cn.map(c=>[c.from,c.to]);const cc=l.correctConnections;const ok=cc.every(cor=>uc.some(u=>u[0]===cor[0]&&u[1]===cor[1]))&&uc.length===cc.length;if(ok){if(!cl.includes(lv)){cl.push(lv);localStorage.setItem('cl',JSON.stringify(cl));}updateLevelSelector();document.getElementById('cleared-count').textContent=cl.length;document.getElementById('progress-fill').style.width=(cl.length/L.length*100)+'%';const modal=document.getElementById('success-modal');const msg=modal.querySelector('p');if(cl.length===L.length){msg.textContent='ğŸŠ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼å…¨ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼';}else{msg.textContent='ç´ æ™´ã‚‰ã—ã„ï¼æ­£ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚';}modal.classList.add('show');}else{er("æ¥ç¶šãŒé•ã„ã¾ã™ã€‚ãƒ’ãƒ³ãƒˆã‚’è¦‹ã¦ãã ã•ã„");}}
function nextLevel(){document.getElementById('success-modal').classList.remove('show');if(lv<L.length){lv++;init();}else{alert('ğŸ‰ Xã§ã‚·ã‚§ã‚¢ã—ã¦ã€è‡ªå‹•åŒ–ä»²é–“ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼');}}
function er(m){pn.forEach(n=>{n.classList.add('error');setTimeout(()=>n.classList.remove('error'),500);});alert(m);}
function showHint(){const l=L[lv-1];document.getElementById('hint-text').textContent=l.hint;document.getElementById('hint-box').classList.add('show');document.getElementById('answer-box').classList.remove('show');}
function showAnswer(){const l=L[lv-1];let answerText='å¿…è¦ãªãƒãƒ¼ãƒ‰:\n';l.nodes.forEach(t=>answerText+=`  - ${N[t].icon} ${N[t].name}\n`);answerText+='\næ­£ã—ã„æ¥ç¶š:\n';l.correctConnections.forEach(c=>answerText+=`  ${N[c[0]].name} â†’ ${N[c[1]].name}\n`);document.getElementById('answer-text').textContent=answerText;document.getElementById('answer-box').classList.add('show');document.getElementById('hint-box').classList.remove('show');}
function resetCanvas(){cv.innerHTML='<div class="canvas-placeholder">ã“ã“ã«ãƒãƒ¼ãƒ‰ã‚’é…ç½®</div>';pn=[];cn=[];fs=null;nid=0;selectedPaletteNode=null;document.getElementById('hint-box').classList.remove('show');document.getElementById('answer-box').classList.remove('show');us();const paletteNodes=document.querySelectorAll('.palette-node');paletteNodes.forEach(n=>n.classList.remove('selected'));}
function reset(){resetCanvas();}
function resetAllData(){if(confirm('ã™ã¹ã¦ã®ã‚¯ãƒªã‚¢è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){localStorage.removeItem('cl');cl=[];lv=1;init();}}
document.addEventListener('keydown',e=>{if(e.key===' '){e.preventDefault();checkWorkflow();}else if(e.key==='r'||e.key==='R'){e.preventDefault();resetCanvas();}else if(e.key==='h'||e.key==='H'){e.preventDefault();showHint();}});
init();
    </script>
</body>
</html>}